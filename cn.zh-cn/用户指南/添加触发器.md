# 添加触发器<a name="swr_01_0100"></a>

## 操作场景<a name="section47921251155020"></a>

容器镜像服务可搭配云容器引擎CCE、云容器实例CCI一起使用，实现镜像版本更新时自动更新使用该镜像的应用。您只需要为镜像添加一个触发器，通过触发器，可以在每次生成新的镜像版本时，自动执行更新动作，如：自动更新使用该镜像的应用。

>![](public_sys-resources/icon-note.gif) **说明：** 
>目前仅“华北-北京四”区域支持添加云容器实例CCI类型的触发器。

## 前提条件<a name="section178839152200"></a>

更新应用镜像版本之前，请确保已创建容器应用，将镜像部署到云容器引擎CCE或云容器实例CCI。

如未创建，请登录云容器引擎工作负载页面进行创建，具体创建方法请参见[创建无状态负载（Deployment）](https://support.huaweicloud.com/usermanual-cce/cce_01_0047.html)或[创建有状态负载（StatefulSet）](https://support.huaweicloud.com/usermanual-cce/cce_01_0048.html)，或登录云容器实例无状态负载页面进行创建，具体创建方法请参见[创建无状态负载](https://support.huaweicloud.com/usermanual-cci/cci_01_0011.html#section0)。

## 操作步骤<a name="section296664320399"></a>

1.  登录容器镜像服务控制台。
2.  在左侧导航栏选择“我的镜像“，单击右侧镜像名称，进入镜像详情页。
3.  选择“触发器“页签，单击“添加触发器“，根据[表1](#table156232449577)填写相关参数，然后单击“确定“。

    **图 1**  添加触发器<a name="fig0861840155216"></a>  
    ![](figures/添加触发器.png "添加触发器")

    **表 1**  触发器

    <a name="table156232449577"></a>
    <table><thead align="left"><tr id="row362424415719"><th class="cellrowborder" valign="top" width="16%" id="mcps1.2.3.1.1"><p id="p5624164445718"><a name="p5624164445718"></a><a name="p5624164445718"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="84%" id="mcps1.2.3.1.2"><p id="p86248445574"><a name="p86248445574"></a><a name="p86248445574"></a>说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row126241344125712"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p1462474475716"><a name="p1462474475716"></a><a name="p1462474475716"></a><span class="keyword" id="keyword1246633113919"><a name="keyword1246633113919"></a><a name="keyword1246633113919"></a>触发器名称</span></p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p069612226278"><a name="p069612226278"></a><a name="p069612226278"></a>自定义触发器的名称。</p>
    <p id="p126245448576"><a name="p126245448576"></a><a name="p126245448576"></a>字母开头，由字母、数字、下划线_、中划线-组成，下划线、中划线不能连续且不能作为结尾，1-64个字符。</p>
    </td>
    </tr>
    <tr id="row1462434455710"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p1362474485717"><a name="p1362474485717"></a><a name="p1362474485717"></a><span class="keyword" id="keyword10287153683920"><a name="keyword10287153683920"></a><a name="keyword10287153683920"></a>触发条件</span></p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p987113416590"><a name="p987113416590"></a><a name="p987113416590"></a>支持如下三种触发条件，当镜像有新版本时，触发部署应用。</p>
    <a name="ul1923411281905"></a><a name="ul1923411281905"></a><ul id="ul1923411281905"><li><span class="keyword" id="keyword127451238123912"><a name="keyword127451238123912"></a><a name="keyword127451238123912"></a>全部触发</span>：有新的镜像版本生成或镜像版本发生更新时，触发部署。</li><li><span class="keyword" id="keyword129244114395"><a name="keyword129244114395"></a><a name="keyword129244114395"></a>指定版本号触发</span>：有指定镜像版本生成或更新时，触发部署。</li><li><span class="keyword" id="keyword5960114343916"><a name="keyword5960114343916"></a><a name="keyword5960114343916"></a>正则触发</span>：有符合正则表达式的镜像版本生成或更新时，触发部署。正则表达式规则如下：<a name="ul359181755212"></a><a name="ul359181755212"></a><ul id="ul359181755212"><li><strong id="b199512396517"><a name="b199512396517"></a><a name="b199512396517"></a>*</strong>：匹配不包含路径分隔符<span class="parmname" id="parmname083411104160"><a name="parmname083411104160"></a><a name="parmname083411104160"></a>“/”</span>的任何字段。</li><li><strong id="b1471924219514"><a name="b1471924219514"></a><a name="b1471924219514"></a>**</strong>：匹配包含路径分隔符<span class="parmname" id="parmname177627619167"><a name="parmname177627619167"></a><a name="parmname177627619167"></a>“/”</span>的任何字段。</li><li><strong id="b146701646105114"><a name="b146701646105114"></a><a name="b146701646105114"></a>?</strong>：匹配任何单个非<span class="parmname" id="parmname1858813212168"><a name="parmname1858813212168"></a><a name="parmname1858813212168"></a>“/”</span>的字符。</li><li><strong id="b12446752105119"><a name="b12446752105119"></a><a name="b12446752105119"></a>{选项1, 选项2, ...}</strong>：同时匹配多个选项。</li></ul>
    </li></ul>
    </td>
    </tr>
    <tr id="row1362494415711"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p16251445579"><a name="p16251445579"></a><a name="p16251445579"></a><span class="keyword" id="keyword10806184717394"><a name="keyword10806184717394"></a><a name="keyword10806184717394"></a>触发动作</span></p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p1068015591009"><a name="p1068015591009"></a><a name="p1068015591009"></a>当前仅支持更新容器的镜像，需指定更新的应用，以及该应用下的容器。</p>
    </td>
    </tr>
    <tr id="row2034315951713"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p1134420921719"><a name="p1134420921719"></a><a name="p1134420921719"></a><span class="keyword" id="keyword6338155313913"><a name="keyword6338155313913"></a><a name="keyword6338155313913"></a>触发器状态</span></p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p20221155710"><a name="p20221155710"></a><a name="p20221155710"></a>选择<span class="uicontrol" id="uicontrol3459447219"><a name="uicontrol3459447219"></a><a name="uicontrol3459447219"></a>“启用”</span>。</p>
    </td>
    </tr>
    <tr id="row485114814505"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p108523875019"><a name="p108523875019"></a><a name="p108523875019"></a>触发器类型</p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p885214845014"><a name="p885214845014"></a><a name="p885214845014"></a>选择“云容器引擎CCE”或“云容器实例CCI”。</p>
    <div class="note" id="note19415112918125"><a name="note19415112918125"></a><a name="note19415112918125"></a><span class="notetitle"> 说明： </span><div class="notebody"><p id="p841622918126"><a name="p841622918126"></a><a name="p841622918126"></a>当前仅“华北-北京四”区域支持“云容器实例CCI”的触发器类型。</p>
    </div></div>
    </td>
    </tr>
    <tr id="row1867154816580"><td class="cellrowborder" valign="top" width="16%" headers="mcps1.2.3.1.1 "><p id="p8681348135814"><a name="p8681348135814"></a><a name="p8681348135814"></a>选择应用</p>
    </td>
    <td class="cellrowborder" valign="top" width="84%" headers="mcps1.2.3.1.2 "><p id="p20682482582"><a name="p20682482582"></a><a name="p20682482582"></a>选择要更新镜像的容器。</p>
    </td>
    </tr>
    </tbody>
    </table>


## 示例1：触发条件为“全部触发“<a name="section4967104383910"></a>

假设有一个欢迎页面为“Hello, SWR!“的Nginx镜像（版本号为v1），使用该镜像创建了名称为“nginx“的无状态负载，该负载提供对外访问。

![](figures/触发器1.png)

1.  为Nginx镜像添加触发器。

    触发器名称填写“All\_tags“，触发条件选择“全部触发“，选择使用了Nginx镜像的无状态负载及容器。

    **图 2**  添加触发器<a name="fig1972317423465"></a>  
    ![](figures/添加触发器-0.png "添加触发器-0")

2.  Nginx镜像新增一个v2版本，该版本的欢迎页面为“Hello, SoftWare Repository for Container!“。

    **图 3**  镜像版本v2<a name="fig13136619154918"></a>  
    ![](figures/镜像版本v2.png "镜像版本v2")

3.  确认是否触发成功。

    在“触发器“页签，单击![](figures/展开.png)图标，查看触发结果为“成功“。

    **图 4**  触发结果<a name="fig13461497520"></a>  
    ![](figures/触发结果.png "触发结果")

    工作负载的访问页面已变更为“Hello, SoftWare Repository for Container!“。

    ![](figures/触发器2.png)


## 示例2：触发条件为“正则触发“<a name="section4224101213324"></a>

假设有一个欢迎页面为“Hello, SWR!“的Nginx镜像（版本号为v1），使用该镜像创建了名称为“nginx“的无状态负载，该负载提供对外访问。

![](figures/触发器1-1.png)

1.  为Nginx镜像添加触发器。

    触发器名称填写“Tags\_regular\_expression“，触发条件选择“正则触发“，输入正则表达式：^v2.\*（匹配以v2开头的版本号），选择使用了Nginx镜像的无状态负载及容器。

    **图 5**  添加触发器<a name="fig399813561210"></a>  
    ![](figures/添加触发器-2.png "添加触发器-2")

2.  Nginx镜像新增一个v1.0.0版本，该版本的欢迎页面为“Hello, SWR! \(v1.0.0\)“。

    **图 6**  镜像版本v1.0.0<a name="fig459212255"></a>  
    ![](figures/镜像版本v1-0-0.png "镜像版本v1-0-0")

3.  Nginx镜像新增一个v2.0.0版本，该版本的欢迎页面为“Hello, SWR! \(v2.0.0\)“。

    **图 7**  镜像版本v2.0.0<a name="fig42791210192814"></a>  
    ![](figures/镜像版本v2-0-0.png "镜像版本v2-0-0")

4.  确认是否触发成功。

    在“触发器“页签，单击![](figures/展开-3.png)图标，查看触发结果。从[图8](#fig288893010313)中可以看出，只有v2.0.0版本被触发了，符合设置的正则表达式规则。

    **图 8**  触发结果<a name="fig288893010313"></a>  
    ![](figures/触发结果-4.png "触发结果-4")

    工作负载的访问页面已变更为“Hello, SWR! \(v2.0.0\)“。

    ![](figures/触发器11.png)


